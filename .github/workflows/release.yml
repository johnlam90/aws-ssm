name: Release

on:
  push:
    tags:
      - 'v*'      # Matches v0.3.0, v1.0.0, etc.
      - '[0-9]*'  # Matches 0.3.0, 1.0.0, etc.

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Get version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          VERSION=${TAG#v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Run tests
        run: go test -v -race ./...

      - name: Build binaries
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          GIT_COMMIT: ${{ github.sha }}
          BUILD_DATE: ${{ github.event.head_commit.timestamp }}
        run: |
          mkdir -p dist
          
          # Build for all platforms
          platforms=("darwin/amd64" "darwin/arm64" "linux/amd64" "linux/arm64" "windows/amd64")
          
          for platform in "${platforms[@]}"; do
            IFS='/' read -r -a array <<< "$platform"
            GOOS="${array[0]}"
            GOARCH="${array[1]}"
            
            output_name="aws-ssm-${GOOS}-${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output_name="${output_name}.exe"
            fi
            
            echo "Building for $GOOS/$GOARCH..."
            GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags "-X github.com/johnlam90/aws-ssm/pkg/version.Version=${VERSION} \
                        -X github.com/johnlam90/aws-ssm/pkg/version.GitCommit=${GIT_COMMIT:0:7} \
                        -X github.com/johnlam90/aws-ssm/pkg/version.BuildDate=${BUILD_DATE}" \
              -o "dist/${output_name}" .
          done

      - name: Create archives
        run: |
          cd dist
          
          # Create tar.gz for Unix systems
          for file in aws-ssm-darwin-* aws-ssm-linux-*; do
            if [ -f "$file" ]; then
              tar -czf "${file}.tar.gz" "$file"
              rm "$file"
            fi
          done
          
          # Create zip for Windows
          for file in aws-ssm-windows-*.exe; do
            if [ -f "$file" ]; then
              zip "${file%.exe}.zip" "$file"
              rm "$file"
            fi
          done

      - name: Generate checksums
        run: |
          cd dist
          shasum -a 256 * > checksums.txt

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## AWS SSM CLI v${{ steps.get_version.outputs.VERSION }}
          
          ### Installation
          
          #### macOS
          
          **Intel (amd64):**
          ```bash
          curl -L https://github.com/johnlam90/aws-ssm/releases/download/v${{ steps.get_version.outputs.VERSION }}/aws-ssm-darwin-amd64.tar.gz | tar xz
          chmod +x aws-ssm-darwin-amd64
          sudo mv aws-ssm-darwin-amd64 /usr/local/bin/aws-ssm
          ```
          
          **Apple Silicon (arm64):**
          ```bash
          curl -L https://github.com/johnlam90/aws-ssm/releases/download/v${{ steps.get_version.outputs.VERSION }}/aws-ssm-darwin-arm64.tar.gz | tar xz
          chmod +x aws-ssm-darwin-arm64
          sudo mv aws-ssm-darwin-arm64 /usr/local/bin/aws-ssm
          ```
          
          #### Linux
          
          **amd64:**
          ```bash
          curl -L https://github.com/johnlam90/aws-ssm/releases/download/v${{ steps.get_version.outputs.VERSION }}/aws-ssm-linux-amd64.tar.gz | tar xz
          chmod +x aws-ssm-linux-amd64
          sudo mv aws-ssm-linux-amd64 /usr/local/bin/aws-ssm
          ```
          
          **arm64:**
          ```bash
          curl -L https://github.com/johnlam90/aws-ssm/releases/download/v${{ steps.get_version.outputs.VERSION }}/aws-ssm-linux-arm64.tar.gz | tar xz
          chmod +x aws-ssm-linux-arm64
          sudo mv aws-ssm-linux-arm64 /usr/local/bin/aws-ssm
          ```
          
          #### Windows
          
          Download `aws-ssm-windows-amd64.zip`, extract it, and add the directory to your PATH.
          
          ### Verification
          
          Verify the installation:
          ```bash
          aws-ssm version
          ```
          
          ### Checksums
          
          SHA256 checksums are available in `checksums.txt`.
          
          ### What's New
          
          See [CHANGELOG.md](https://github.com/johnlam90/aws-ssm/blob/main/CHANGELOG.md) for details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          VERSION=${TAG#v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: sleep 30

      - name: Download release assets for checksums
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Download macOS arm64 for Homebrew
          curl -L -o aws-ssm-darwin-arm64.tar.gz \
            "https://github.com/johnlam90/aws-ssm/releases/download/v${VERSION}/aws-ssm-darwin-arm64.tar.gz"
          
          # Calculate SHA256
          SHA256=$(shasum -a 256 aws-ssm-darwin-arm64.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_ENV
          echo "Calculated SHA256: ${SHA256}"

      - name: Create Homebrew formula
        run: |
          mkdir -p homebrew-formula
          cat > homebrew-formula/aws-ssm.rb << 'EOF'
          class AwsSsm < Formula
            desc "AWS Systems Manager (SSM) CLI for managing EC2 instances"
            homepage "https://github.com/johnlam90/aws-ssm"
            version "${{ steps.get_version.outputs.VERSION }}"
            
            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/johnlam90/aws-ssm/releases/download/v#{version}/aws-ssm-darwin-arm64.tar.gz"
                sha256 "${{ env.SHA256 }}"
              else
                url "https://github.com/johnlam90/aws-ssm/releases/download/v#{version}/aws-ssm-darwin-amd64.tar.gz"
                sha256 "PLACEHOLDER_AMD64_SHA256"
              end
            end
            
            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/johnlam90/aws-ssm/releases/download/v#{version}/aws-ssm-linux-arm64.tar.gz"
                sha256 "PLACEHOLDER_LINUX_ARM64_SHA256"
              else
                url "https://github.com/johnlam90/aws-ssm/releases/download/v#{version}/aws-ssm-linux-amd64.tar.gz"
                sha256 "PLACEHOLDER_LINUX_AMD64_SHA256"
              end
            end
            
            def install
              bin.install Dir["aws-ssm-*"].first => "aws-ssm"
            end
            
            test do
              system "#{bin}/aws-ssm", "version"
            end
          end
          EOF

      - name: Upload Homebrew formula as artifact
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula
          path: homebrew-formula/aws-ssm.rb

